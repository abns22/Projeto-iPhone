{% extends "base_modern.html" %}

{% block title %}Editar Modelo - {{ modelo['nome_modelo'] }}{% endblock %}

{% block page_indicator %}Admin{% endblock %}

{% block header_nav %}
    <a href="{{ url_for('admin_dashboard') }}" class="header-nav-item">
        <i class="fas fa-gauge"></i>
        <span>Admin</span>
    </a>
    <a href="{{ url_for('gerenciar_modelos_admin') }}" class="header-nav-item active">
        <i class="fas fa-cubes"></i>
        <span>Modelos</span>
    </a>
    <a href="{{ url_for('gerenciar_usuarios_admin') }}" class="header-nav-item">
        <i class="fas fa-users"></i>
        <span>Usu√°rios</span>
    </a>
    <a href="{{ url_for('gerar_link_convite') }}" class="header-nav-item">
        <i class="fas fa-link"></i>
        <span>Convites</span>
    </a>
    <a href="{{ url_for('relatorios_dashboard') }}" class="header-nav-item">
        <i class="fas fa-chart-bar"></i>
        <span>Relat√≥rios</span>
    </a>
{% endblock %}

{% block mobile_nav %}
    <a href="{{ url_for('admin_dashboard') }}" class="header-nav-item">
        <i class="fas fa-gauge"></i>
        <span>Painel de Administra√ß√£o</span>
    </a>
    <a href="{{ url_for('gerenciar_modelos_admin') }}" class="header-nav-item active">
        <i class="fas fa-cubes"></i>
        <span>Gerenciar Modelos</span>
    </a>
    <a href="{{ url_for('gerenciar_usuarios_admin') }}" class="header-nav-item">
        <i class="fas fa-users"></i>
        <span>Gerenciar Usu√°rios</span>
    </a>
    <a href="{{ url_for('gerar_link_convite') }}" class="header-nav-item">
        <i class="fas fa-link"></i>
        <span>Gerar Link de Convite</span>
    </a>
    <a href="{{ url_for('relatorios_dashboard') }}" class="header-nav-item">
        <i class="fas fa-chart-bar"></i>
        <span>Relat√≥rios</span>
    </a>
{% endblock %}

{% block extra_css %}
<style>
    .armazenamento-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }
    .armazenamento-info-box {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .armazenamento-info-box h4 {
        color: #1976d2;
        margin: 0 0 10px 0;
        font-size: 16px;
    }
    .armazenamento-info-box p {
        margin: 5px 0;
        color: #424242;
        font-size: 14px;
    }
    .armazenamento-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .armazenamento-item {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .armazenamento-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .armazenamento-capacidade {
        font-weight: bold;
        color: #333;
        font-size: 16px;
    }
    .valor-base-info {
        font-size: 12px;
        color: #666;
        background: #f5f5f5;
        padding: 5px 8px;
        border-radius: 4px;
    }
    .modificador-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    .modificador-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    .modificador-input:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    .valor-final {
        font-weight: bold;
        color: #2e7d32;
        font-size: 16px;
        padding: 8px 12px;
        background: #e8f5e8;
        border-radius: 4px;
        text-align: center;
        min-width: 120px;
    }
    .valor-negativo { color: #d32f2f; background: #ffebee; }
    .valor-zero { color: #666; background: #f5f5f5; }
    .explicacao-texto { font-size: 12px; color: #666; margin-top: 5px; font-style: italic; }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 20px;">
        <h1 style="margin: 0;">Editando: {{ modelo['nome_modelo'] }}</h1>
        <a href="{{ url_for('gerenciar_modelos_admin') }}" class="btn-editar" style="text-decoration: none;">Voltar para a Lista</a>
    </div>

    <form method="POST" action="{{ url_for('editar_modelo_admin', modelo_id=modelo.id) }}">
        <div class="admin-warning-box">
            <div class="icon">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <div class="text-content">
                <h3>Aten√ß√£o: √Årea de Alto Impacto</h3>
                <p>As altera√ß√µes feitas nesta se√ß√£o afetam <strong>TODOS</strong> os c√°lculos de avalia√ß√£o para sua empresa. Use com extrema cautela, pois as modifica√ß√µes s√£o <strong>permanentes e n√£o podem ser desfeitas</strong>. 
                Tenha certeza de alterar apenas os campos com <strong>VALORES NEGATIVOS</strong>.</p>
            </div>
        </div>

        <div class="form-section">
            <h2>Valores Base</h2>
            <div class="form-group">
                <label for="nome_modelo">Nome do Modelo:</label>
                <input type="text" id="nome_modelo" name="nome_modelo" value="{{ modelo.nome_modelo }}" required>
            </div>
            <div class="form-group">
                <label for="valor_base_novo">Valor Base (R$):</label>
                <input type="number" step="0.01" id="valor_base_novo" name="valor_base_novo" value="{{ '%.2f'|format(modelo.valor_base_novo|float) }}" required>
            </div>
        </div>

        <div class="form-section armazenamento-section">
            <h2>Valores por Armazenamento</h2>
            <div class="armazenamento-info-box">
                <h4>üìã Como Funciona o Sistema de Valores por Armazenamento</h4>
                <p><strong>Valor Base:</strong> R$ {{ '%.2f'|format(modelo.valor_base_novo|float) }} - Este √© o valor de refer√™ncia para o armazenamento padr√£o.</p>
                <p><strong>Modificador:</strong> Use valores positivos (+) para aumentar ou negativos (-) para diminuir o valor base.</p>
                <p><strong>Exemplo:</strong> Se o valor base √© R$ 1500,00 e voc√™ coloca +200,00, o valor final ser√° R$ 1700,00.</p>
                <p><strong>‚ö†Ô∏è Importante:</strong> Os valores s√£o atualizados em tempo real conforme voc√™ digita.</p>
                <p><strong>‚ÑπÔ∏è Observa√ß√£o:</strong> Campos que j√° aparecem com valores preenchidos s√£o armazenamentos que j√° possuem modificadores cadastrados anteriormente.</p>
            </div>
            <div class="armazenamento-grid">
                {% for armazenamento in armazenamentos %}
                <div class="armazenamento-item">
                    <div class="armazenamento-header">
                        <span class="armazenamento-capacidade">{{ armazenamento.capacidade_gb }} GB</span>
                        <span class="valor-base-info">Base: R$ {{ '%.2f'|format(modelo.valor_base_novo|float) }}</span>
                    </div>
                    <div class="modificador-group">
                        <label for="modificador_{{ armazenamento.id }}">Modificador (R$):</label>
                        <input type="number" step="0.01" class="modificador-input" id="modificador_{{ armazenamento.id }}"
                               name="modificador_armazenamento_{{ armazenamento.id }}"
                               value="{{ '%.2f'|format(armazenamento.modificador_valor|float) if armazenamento.modificador_valor is not none else '0.00' }}"
                               data-valor-base="{{ modelo.valor_base_novo }}"
                               data-armazenamento-id="{{ armazenamento.id }}"
                               placeholder="Ex: +200.00 ou -100.00">
                    </div>
                    <div class="valor-final" id="valor_final_{{ armazenamento.id }}">
                        R$ {{ '%.2f'|format((modelo.valor_base_novo|float) + (armazenamento.modificador_valor|float if armazenamento.modificador_valor is not none else 0.0)) }}
                    </div>
                    <div class="explicacao-texto">Valor final = Base + Modificador</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="form-section">
            <h2>Valores de Impacto (Descontos)</h2>
            <p>Ajuste os valores de desconto para cada condi√ß√£o. Use valores negativos (ex: -250.00).</p>
            <div class="impacto-grid">
                {% for pergunta in perguntas %}
                    <div class="form-group-impacto">
                        <p class="pergunta-texto">{{ pergunta.texto_pergunta }}</p>
                        <div class="impacto-input-group">
                            <label for="impacto_sim_{{ pergunta.id }}">Impacto "Sim":</label>
                            <input type="number" step="0.01" name="impacto_sim_{{ pergunta.id }}" value="{{ '%.2f'|format(pergunta.impacto_sim|float) if pergunta.impacto_sim is not none else '0.00' }}">
                        </div>
                        <div class="impacto-input-group">
                             <label for="impacto_nao_{{ pergunta.id }}">Impacto "N√£o":</label>
                             <input type="number" step="0.01" name="impacto_nao_{{ pergunta.id }}" value="{{ '%.2f'|format(pergunta.impacto_nao|float) if pergunta.impacto_nao is not none else '0.00' }}">
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="form-actions">
            <a href="{{ url_for('gerenciar_modelos_admin') }}" class="btn-cancelar">Cancelar</a>
            <button type="submit" class="btn-editar">Salvar Altera√ß√µes</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function atualizarValorFinal(input) {
        const armazenamentoId = input.dataset.armazenamentoId;
        const valorBase = parseFloat(input.dataset.valorBase);
        const modificador = parseFloat(input.value) || 0;
        const valorFinal = valorBase + modificador;
        const valorFinalElement = document.getElementById(`valor_final_${armazenamentoId}`);
        valorFinalElement.textContent = `R$ ${valorFinal.toFixed(2)}`;
        valorFinalElement.classList.remove('valor-negativo', 'valor-zero');
        if (valorFinal < 0) {
            valorFinalElement.classList.add('valor-negativo');
        } else if (valorFinal === 0) {
            valorFinalElement.classList.add('valor-zero');
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const inputsModificador = document.querySelectorAll('.modificador-input');
        inputsModificador.forEach(input => {
            input.addEventListener('input', function() { atualizarValorFinal(this); });
            atualizarValorFinal(input);
        });
    });
</script>
{% endblock %}